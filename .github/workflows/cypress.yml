name: Cypress Tests
on:
  deployment_status:
  workflow_dispatch:
    inputs:
      browser:
        description: Cypress browser to use

# env:
# RECORD_REPLAY_CHROMIUM_DOWNLOAD_FILE: linux-chromium-20221101-437cdab850ff-dae524f48153.tar.xz

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    if: github.event.deployment_status.state == 'success' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Get PR Number
        uses: actions/github-script@v6
        id: pr-number
        with:
          result-encoding: json
          script: |
            try {
              const results = await github.rest.search.issuesAndPullRequests({
                q: context.sha
              });
              const prs = [...results.data.items].sort((a, b) => a.score - b.score);
              if (prs[0]) {
                return prs[0].number;
              }
            } catch (e) {
              console.error(e);
            }
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup node
        uses: actions/setup-node@v3
        with:
          node-version: 16

      - name: Install dependencies
        run: npm ci

      - name: Run Tests
        uses: replayio/action-cypress@v0.2.2
        with:
          browser: ${{ github.event.inputs.browser || 'Replay Chromium' }}
          api-key: ${{ secrets.CYPRESS_REPLAY_API_KEY }}
          public: true
        env:
          RECORD_REPLAY_VERBOSE: 1
          DEBUG: cypress:launcher*
          RECORD_REPLAY_METADATA_SOURCE_MERGE_ID: ${{ steps.pr-number.outputs.result }}
          CYPRESS_BASE_URL: ${{ github.event.deployment_status.target_url || 'https://www.replayable.dev/' }}
