name: Cypress Tests
on:
  deployment_status:
  workflow_dispatch:
    inputs:
      browser:
        description: Cypress browser to use
jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    if: github.event.deployment_status.state == 'success' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup node
        uses: actions/setup-node@v3
        with:
          node-version: 16

      - name: Install dependencies
        run: npm ci

      - name: Run Tests
        uses: cypress-io/github-action@v4.1.1
        with:
          browser: "Replay Firefox"
        env:
          CYPRESS_BASE_URL: ${{ github.event.deployment_status.target_url || 'https://www.replayable.dev/' }}
          RECORD_ALL_CONTENT: 1
          RECORD_REPLAY_METADATAFILE: /tmp/replay-metadata

      - name: Upload to Replay
        run: |
          npm i -g @replayio/replay@latest
          export RECORD_REPLAY_METADATA_SOURCE_MERGE_ID=${{ steps.pr-number.outputs.result }};
          replay metadata --init --keys source --warn
          replay upload-all
        env:
          RECORD_REPLAY_API_KEY: ${{ secrets.CYPRESS_REPLAY_API_KEY }}
